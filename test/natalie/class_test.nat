require 'spec'

class Foo
  def foo
    'foo'
  end

  def double(x)
    x * 2
  end
end

describe 'class' do
  describe 'instance methods' do
    it 'calls the method and returns the result' do
      foo = Foo.new
      foo.foo.must_equal 'foo'
      Foo.new.foo.must_equal 'foo'
      Foo.new.double(4).must_equal 8
    end
  end
end

# reopen class
class Foo
  def foo2
    'foo2'
  end
end

describe 'class' do
  describe 'reopen class' do
    it 'has both old and new methods' do
      Foo.new.foo2.must_equal 'foo2'
      Foo.new.foo.must_equal 'foo'
    end
  end
end

class Bar < Foo
  def foo
    'bar'
  end
end

describe 'class' do
  describe 'inheritance' do
    it 'has its own methods and those of its superclass' do
      Bar.new.foo.must_equal 'bar'
      Bar.new.double(3).must_equal 6
    end
  end
end

class Baz < Foo
  def foo
    if true
      super + ' baz'
    end
  end
end

describe 'class' do
  describe 'super' do
    it 'calls the same method on the superclass' do
      Baz.new.foo.must_equal 'foo baz'
    end
  end
end

module M1
  def m1
    'm1'
  end
end

module M2
  def m2
    'm2'
  end
end

# reopen module
module M1
  def m1b
    'm1b'
  end
end

class Foo2
  include M1, M2
end

describe 'class' do
  describe 'include' do
    it 'includes methods from a module' do
      Foo2.new.m1.must_equal 'm1'
      Foo2.new.m1b.must_equal 'm1b'
      Foo2.new.m2.must_equal 'm2'
    end
  end
end

class IvarTest
  def set_x(x)
    @x = x
  end

  def get_x
    @x
  end

  def set_y(y)
    instance_variable_set(:@y, y)
  end

  def get_y
    instance_variable_get(:@y)
  end

  def set_z(z)
    @z = z
  end

  def block_test
    result = []
    [1].each do |i|
      result << @z
    end
    result
  end

  attr_reader :z
  attr_reader :z2
  attr_writer :z
  attr_writer :z2
  attr_accessor :zz
  attr_accessor :zz2
end

describe 'class' do
  describe 'instance variables' do
    it 'can be set and returned' do
      i = IvarTest.new
      i.get_x.must_equal nil
      i.set_x(10)
      i.get_x.must_equal 10
      i.set_x(20)
      i.get_x.must_equal 20
      i.set_y(10)
      i.get_y.must_equal 10
      i.set_y(20)
      i.get_y.must_equal 20
      i.z.must_equal nil
      i.z = 10
      i.z.must_equal 10
      i.z = 20
      i.z2 = 200
      i.z.must_equal 20
      i.z2.must_equal 200
      i.zz = 30
      i.zz2 = 300
      i.zz.must_equal 30
      i.zz2.must_equal 300
      i.block_test.must_equal [20]
    end
  end
end

class InitMethodTest
  def initialize
    @x = 1
  end

  def x
    @x
  end
end

class InitMethodTest2
  def initialize(x)
    @x = x
  end

  def x
    @x
  end
end

class InitMethodTest3 < InitMethodTest2
  def x
    @x
  end
end

describe 'class' do
  describe 'initialize method' do
    it 'is called when the object is created' do
      InitMethodTest.new.x.must_equal 1
    end

    it 'is passed arguments' do
      InitMethodTest2.new(2).x.must_equal 2
    end

    it 'is called on superclass if not present' do
      InitMethodTest3.new(3).x.must_equal 3
    end
  end
end

describe 'built-in class/object hierarchy' do
  it 'matches ruby' do
    Integer.class.inspect.must_equal 'Class'
    Class.class.inspect.must_equal 'Class'
    Class.superclass.inspect.must_equal 'Module'
    Module.class.inspect.must_equal 'Class'
    Module.superclass.inspect.must_equal 'Object'
    Integer.superclass.inspect.must_equal 'Numeric'
    Numeric.superclass.inspect.must_equal 'Object'
    Object.superclass.inspect.must_equal 'BasicObject'
    BasicObject.class.inspect.must_equal 'Class'
    BasicObject.superclass.inspect.must_equal 'nil'
  end
end

run_specs
